{% extends 'donor/base.html' %}

{% block title %}
    PULSE
{% endblock title %}
    
{% block main %}

<div style="text-transform: uppercase;color: red;" class="pluse_banner">
  <h1 >Blood Requests</h1>
</div>

<div class="posts">
<form method="get" style="margin-bottom:20px; display:flex; gap:10px; flex-wrap:wrap;">
  <div class="select">

    <!-- Blood Group -->
    <select name="blood_group" style="border: black 1px solid;  color: black;">
      <option style="color: #fff;" value="all" {% if request.GET.blood_group == "all" or not request.GET.blood_group %}selected{% endif %}>All Blood Groups</option>
      <option style="color: #fff;" value="A+" {% if request.GET.blood_group == "A+" %}selected{% endif %}>A+</option>
      <option style="color: #fff;" value="A-" {% if request.GET.blood_group == "A-" %}selected{% endif %}>A-</option>
      <option style="color: #fff;" value="B+" {% if request.GET.blood_group == "B+" %}selected{% endif %}>B+</option>
      <option style="color: #fff;" value="B-" {% if request.GET.blood_group == "B-" %}selected{% endif %}>B-</option>
      <option style="color: #fff;" value="AB+" {% if request.GET.blood_group == "AB+" %}selected{% endif %}>AB+</option>
      <option style="color: #fff;" value="AB-" {% if request.GET.blood_group == "AB-" %}selected{% endif %}>AB-</option>
      <option style="color: #fff;" value="O+" {% if request.GET.blood_group == "O+" %}selected{% endif %}>O+</option>
      <option style="color: #fff;" value="O-" {% if request.GET.blood_group == "O-" %}selected{% endif %}>O-</option>
    </select>

    <!-- Location -->
    <select name="location" style="border: black 1px solid;  color: black;">
      <option style="color: #fff;" value="all" {% if request.GET.location == "all" or not request.GET.location %}selected{% endif %}>All Districts</option>
      <option style="color: #fff;" value="Dhaka" {% if request.GET.location == "Dhaka" %}selected{% endif %}>Dhaka</option>
      <option style="color: #fff;" value="Chattogram" {% if request.GET.location == "Chattogram" %}selected{% endif %}>Chattogram</option>
      <option style="color: #fff;" value="Rajshahi" {% if request.GET.location == "Rajshahi" %}selected{% endif %}>Rajshahi</option>
      <option style="color: #fff;" value="Khulna" {% if request.GET.location == "Khulna" %}selected{% endif %}>Khulna</option>
      <option style="color: #fff;" value="Barishal" {% if request.GET.location == "Barishal" %}selected{% endif %}>Barishal</option>
      <option style="color: #fff;" value="Sylhet" {% if request.GET.location == "Sylhet" %}selected{% endif %}>Sylhet</option>
      <option style="color: #fff;" value="Rangpur" {% if request.GET.location == "Rangpur" %}selected{% endif %}>Rangpur</option>
      <option style="color: #fff;" value="Mymensingh" {% if request.GET.location == "Mymensingh" %}selected{% endif %}>Mymensingh</option>
    </select>

    <!-- Post Type -->
    <select name="post_type" style="border: black 1px solid; color: black;">
      <option style="color: #fff;" value="all" {% if request.GET.post_type == "all" or not request.GET.post_type %}selected{% endif %}>All Posts</option>
      <option style="color: #fff;" value="receiver" {% if request.GET.post_type == "receiver" %}selected{% endif %}>Receiver</option>
      <option style="color: #fff;" value="donor" {% if request.GET.post_type == "donor" %}selected{% endif %}>Donor</option>
    </select>

    <button type="submit" class="btn">Filter</button>
  </div>
</form>

  {% for post in posts %}
    <div class="post" id="post-{{ post.id }}" style="border:1px solid #ddd; padding:15px; margin-bottom:15px; border-radius:10px;">
      
      <!-- User Info -->
      <div style="display:flex; align-items:center; gap:10px; margin-bottom:10px;">
        <img src="{{ post.user.profile.profile_pic.url }}" 
             alt="{{ post.user.username }}" 
             style="width:50px; height:50px; border-radius:50%; object-fit:cover; border:1px solid #ccc;">
        <div>
          <strong style="text-transform: uppercase;">{{ post.user.username }}</strong><br>
          <small>{{ post.created_at|date:"M d, Y H:i" }}</small>
        </div>
      </div>

      <!-- Post Content -->
      <h3 style="color: red;">{{ post.name }} ({{ post.blood_group }})</h3>
      <p><strong style="color: red;">Problem:</strong> {{ post.problem }}</p>
      <p><strong style="color: red;">Location:</strong> {{ post.location }}</p>

{% if post.post_type == "donated" %}
    <button class="btn" style="background: gray;">Donated ✅</button>
{% elif user.is_authenticated and post.id in user_requests %}
    <button class="btn" style="background: orange;">Already Sent ✅</button>
{% else %}
    <a href="{% url 'donate_now' post.id %}">
        <button class="btn">Donate</button>
    </a>
{% endif %}


      <!-- Comment toggle button -->
      <button class="btn toggle-comments" data-post-id="{{ post.id }}">COMMENT</button>

      <!-- Comment Section (Initially hidden) -->
      <div class="comments-section" id="comments-{{ post.id }}" style="display:none; margin-top:10px;">
        <div class="comment-list" ></div>

        <!-- Comment Form -->
        {% if user.is_authenticated %}
        <form style="margin-top: 10px;" class="comment-form" data-post-id="{{ post.id }}">
          {% csrf_token %}
          <input type="text" name="text" placeholder="Write a comment..." required>
          <button type="submit" style="background-color: transparent;
          color:red; font-family: poppins;border: none; font-size: 18px;font-weight: 600;">Post</button>
        </form>
        {% else %}
          <p style="color:red;">Please login to comment.</p>
        {% endif %}
      </div>
    </div>
  {% empty %}
    <p style="text-align: center; text-transform: uppercase; color: red;">No requests yet.</p>
  {% endfor %}
</div>

<!-- AJAX Script -->
<script>
document.addEventListener("DOMContentLoaded", function() {
  // Toggle comments
  document.querySelectorAll(".toggle-comments").forEach(btn => {
    btn.addEventListener("click", function() {
      let postId = this.dataset.postId;
      let section = document.getElementById("comments-" + postId);

      if (section.style.display === "none") {
        // Show comments
        fetch(`/comments/${postId}/`)
          .then(res => res.json())
          .then(data => {
            let commentList = section.querySelector(".comment-list");
            commentList.innerHTML = "";
            data.comments.forEach(c => {
              commentList.innerHTML += `<p style="text-transform: uppercase;background-color:#ff7b7b8a;width: fit-content; padding: 8px; border-radius: 5px; margin-top: 5px; "><b>${c.user}</b>: ${c.text} <small>(${c.created_at})</small></p>`;
            });
          });
        section.style.display = "block";
        this.innerText = "HIDE COMMENTS";
      } else {
        section.style.display = "none";
        this.innerText = "COMMENT";
      }
    });
  });

  // Add comment
  document.querySelectorAll(".comment-form").forEach(form => {
    form.addEventListener("submit", function(e) {
      e.preventDefault();
      let postId = this.dataset.postId;
      let formData = new FormData(this);
      fetch(`/comments/${postId}/add/`, {
        method: "POST",
        body: formData,
        headers: { "X-CSRFToken": this.querySelector("[name=csrfmiddlewaretoken]").value }
      })
      .then(res => res.json())
      .then(data => {
        if (!data.error) {
          let commentList = document.getElementById("comments-" + postId).querySelector(".comment-list");
          commentList.innerHTML = `<p ><b >${data.user}</b>: ${data.text} <small>(${data.created_at})</small></p>` + commentList.innerHTML;
          this.reset();
        }
      });
    });
  });
});
function showToast(msg) {
  let toast = document.createElement("div");
  toast.innerText = msg;
  toast.style.position = "fixed";
  toast.style.bottom = "20px";
  toast.style.right = "20px";
  toast.style.background = "#333";
  toast.style.color = "#fff";
  toast.style.padding = "10px 20px";
  toast.style.borderRadius = "5px";
  toast.style.zIndex = "9999";
  document.body.appendChild(toast);

  setTimeout(() => {
    toast.remove();
  }, 2500);
}

</script>

{% endblock main %}
