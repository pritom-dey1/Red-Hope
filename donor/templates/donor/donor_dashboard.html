{% extends 'donor/base.html' %}
{% load static %}

{% block title %}
  {{ request.user.username }}
{% endblock title %}

{% block main %}
<div class="dashboard">
  <div class="dash_box">
    <div class="profile_pic">
      <img src="{{ request.user.profile.profile_pic.url }}" alt="Profile Picture"
           style="width:120px;height:120px;border-radius:50%;">
    </div>

    <!-- Profile Picture Upload Form -->
    <form class="dp_change" action="{% url 'donor_dashboard' %}" method="post" enctype="multipart/form-data">
      {% csrf_token %}
      <label for="profile_pic" class="custom-file-upload">Choose Profile Picture</label>
      <input id="profile_pic" type="file" name="profile_pic" accept="image/*">
      <button type="submit">Update Picture</button>
    </form>

    <h1 style=" display: flex; margin-top: 10px;">
      WELCOME, <span style="text-transform: uppercase;">{{ request.user.username }}</span>
      {% if total_success >= 5 %}
       <img style="width: 30px; height: 20px;" src="{% static 'img/baged.png' %}" alt="">
      {% endif %}
    </h1>
    <h2>Donor Dashboard</h2>
    <div class="dashdetails">
      <p>Your Blood Group: {{ request.user.profile.blood_group }}</p>
      <p>Account Type: Donor</p>
    </div>
  </div>

  <div class="dash_content" style="color: #fff;">
    <!-- ====== Tab Buttons ====== -->
    <div class="tab-buttons" style="margin:20px 0; text-align:center;">
      <button onclick="showTab('history')" class="btn">üìã Donation History</button>
      <button onclick="showTab('stats')" class="btn">üìä My Stats</button>
      <button onclick="showTab('badge')" class="btn">üèÖ Hero Badge</button>
    </div>

    <!-- ====== Tab Content ====== -->

    <!-- Donation History -->
    <div id="history" class="tab-content">
      <h3 style="text-align: center;text-transform: uppercase;"> My Donation Requests</h3>
      {% for donation in donations %}
        <div style="margin-top:10px; border:1px solid #ddd; padding:15px; border-radius:10px; margin-bottom:15px;">
          <p><b>Receiver:</b> {{ donation.post.name }} ({{ donation.post.blood_group }})</p>
          <p><b>Location:</b> {{ donation.post.location }}</p>
          <p><b>Status:</b> {{ donation.status|capfirst }}</p>
          <small>Requested: {{ donation.created_at }}</small>
        </div>
      {% empty %}
        <p style="text-align:center; color:red;">You have not donated yet.</p>
      {% endfor %}  
    </div>

    <!-- Stats -->
    <div id="stats" class="tab-content" style="display:none;">
      <h3 style="text-align: center; text-transform: uppercase;">My Statistics</h3>
          <div class="impact_boxs">
        <div class="impact_box">
            <span style="color: red; font-size: 20px; font-weight: 600;">{{ total_requests }}</span>
            <p>Total Requests</p>
        </div>
        <div class="impact_box">
            <span style="color: red; font-size: 20px; font-weight: 600;"> {{ total_success }}</span>
            <p>Successful Donations</p>
        </div>
        <div class="impact_box">
            <span style="color: red; font-size: 20px; font-weight: 600;">{{total_rejected}}</span>
            <p> Rejection</p>
        </div>

    </div>
    
    </div>

    <!-- Hero Badge -->
    <div id="badge" class="tab-content" style="display:none;">
      <h3 style="text-align: center; text-transform: uppercase;">Hero Badge</h3>
      {% if total_success >= 5 %}
        <p style="color:gold; font-weight:bold; text-align: center;">
          ‚≠ê Congratulations! You are a Hero Donor ‚≠ê
        </p>
        <p style="text-align: center;text-transform: uppercase;">Your badge will always appear next to your name.</p>
      {% else %}
        <p style="text-align: center; text-transform: uppercase;">You need <b>{{ 5|add:"-total_success" }}</b> more successful donations to earn the Hero Badge.</p>
      {% endif %}
    </div>
  </div>
</div>

<!-- ====== JS for Tabs ====== -->
<script>
  function showTab(tabId) {
    document.querySelectorAll(".tab-content").forEach(el => el.style.display = "none");
    document.getElementById(tabId).style.display = "block";
  }
</script>
{% endblock main %}
